name: Delete ALL workflow runs

on:
  workflow_dispatch:  # æ‰‹å‹•è§¸ç™¼

permissions:
  actions: write
  contents: read

concurrency:
  group: delete-all-runs
  cancel-in-progress: false

jobs:
  delete-all:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GH_REPO: ${{ github.repository }}
      SELF_RUN_ID: ${{ github.run_id }}
    steps:
      - name: Delete completed workflow runs (skip current run)
        shell: bash
        run: |
          echo "ğŸš¨ æ­£åœ¨åˆªé™¤ $GH_REPO ä¸­æ‰€æœ‰å·²å®Œæˆçš„ workflow runsï¼ˆæ’é™¤æœ¬æ¬¡ runï¼‰..."
          while :; do
            ids=$(gh run list --repo "$GH_REPO" \
              --status completed --limit 100 \
              --json databaseId \
              --jq '.[].databaseId')
            if [ -z "$ids" ]; then
              echo "âœ… æ²’æœ‰å¯åˆªé™¤çš„ runsï¼ŒçµæŸã€‚"
              break
            fi
            count=0
            for id in $ids; do
              # è·³éæ­£åœ¨åŸ·è¡Œé€™å€‹å·¥ä½œæµæœ¬èº«çš„ run
              if [ "$id" = "$SELF_RUN_ID" ]; then
                echo "â­ï¸ è·³éç›®å‰é€™å€‹ run: $id"
                continue
              fi
              if gh run delete "$id" --repo "$GH_REPO"; then
                count=$((count+1))
              else
                echo "âš ï¸ ç„¡æ³•åˆªé™¤ run $idï¼Œç•¥é"
              fi
            done
            echo "ğŸ—‘ï¸ é€™ä¸€è¼ªåˆªé™¤äº† $count ç­†ã€‚"
          done
          echo "ğŸ”¥ å·²å®Œæˆæ¸…ç†ï¼ˆåƒ…åˆªé™¤ completedï¼‰ã€‚"
